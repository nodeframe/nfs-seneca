{"version":3,"sources":["../src/index.js"],"names":["senecaOptions","transportConfig","si","Module","parseOption","act","args","resolve","reject","err","resp","ok","deserializeError","error","result","add","options","callback","done","length","bind","resultWithArgs","isThenable","then","response","catch","e","serializeError","type","console","log","Mesh","init","registerHealthCheck","name","stack","message","errors","oe","Error"],"mappings":"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","file":"index.js","sourcesContent":["import seneca from 'seneca';\nimport Promise from 'bluebird';\nimport {register} from './register';\nimport * as Mesh from './plugin/mesh';\nimport * as Module from \"./module\";\n\nconst serializeError = (e)=> {\n  return {name: e.name, stack: e.stack, message: e.message, errors: e.errors};\n}\n\nconst deserializeError = (oe)=> {\n  const e = new Error(oe.message);\n  e.name = oe.name;\n  e.errors = oe.errors;\n  e.stack = oe.stack;\n  return e;\n}\n\nexport default function (senecaOptions, transportConfig = {}) {\n  const si = seneca(Module.parseOption(senecaOptions));\n\n  const act = (args) => {\n    return new Promise((resolve, reject)=> {\n      si.act(args, function (err, resp) {\n        if (err) {\n          reject(err);\n          return;\n        }\n        else if (!resp.ok) reject(deserializeError(resp.error));\n        else resolve(resp.result);\n      });\n    });\n  }\n\n  const add = (options, callback)=> {\n    si.add(options, function (args, done) {\n      try {\n        if (callback.length >= 2) {\n          callback.bind(si)(args, done);\n        } else {\n          const resultWithArgs = callback.bind(si)(args);\n          const isThenable = ('function' === typeof resultWithArgs.then);\n          if (isThenable) {\n            resultWithArgs.then((response)=> {\n              done(null, {ok: true, result: response});\n            }).catch((e)=> {\n              done(null, {ok: false, error: serializeError(e)});\n            });\n          } else {\n            done(null, {ok: true, result: resultWithArgs});\n          }\n        }\n      } catch (e) {\n        done(null, {ok: false, error: serializeError(e)});\n        return;\n      }\n    })\n  }\n\n  switch (transportConfig.type) {\n    case 'mesh':\n      console.log(\"nfs-seneca mesh mode!\")\n      Mesh.init(si, transportConfig)\n      break\n    default:\n      console.log(\"nfs-seneca normal mode\")\n      register(si, transportConfig)\n      break\n  }\n\n  Module.registerHealthCheck(si, transportConfig)\n\n  return {act, add, si};\n};"]}